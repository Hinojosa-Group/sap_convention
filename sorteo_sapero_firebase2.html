<!DOCTYPE html>

<html lang="es"> <head> <meta charset="UTF-8"> <meta name="viewport" content="width=device-width, initial-scale=1.0"> <title>Hinojosa Packaging | Sorteo SAP Navidad</title> <script src="https://cdn.tailwindcss.com"></script> <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;700&display=swap" rel="stylesheet">

<style>
    body { 
        font-family: 'Montserrat', sans-serif; 
        background-color: #f9fafb;
    }
    /* Verde Corporativo Hinojosa (Extra√≠do de la imagen) */
    .bg-hinojosa { background-color: #005836; }
    .text-hinojosa { color: #005836; }
    .border-hinojosa { border-color: #005836; }
    
    /* Verde secundario/acento (tipo el de 'Products' hover o l√≠neas decorativas) */
    .bg-hinojosa-light { background-color: #4ade80; } 
    
    .box-closed {
        background: linear-gradient(135deg, #005836 0%, #004d2e 100%);
        transition: transform 0.2s, box-shadow 0.2s;
    }
    .box-closed:hover {
        transform: translateY(-4px);
        box-shadow: 0 10px 15px -3px rgba(0, 88, 54, 0.3);
    }

    /* Animaci√≥n de carga */
    @keyframes pulse-green {
        0%, 100% { opacity: 1; }
        50% { opacity: .5; }
    }
    .animate-pulse-green {
        animation: pulse-green 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }
</style>

<script type="module">
    import { initializeApp } from "[https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js](https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js)";
    import { getDatabase, ref, set, get, onValue, update, remove } from "[https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js](https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js)";

    // ======================================================
    // ‚ö†Ô∏è PEGA AQU√ç TU CONFIGURACI√ìN DE FIREBASE
    // (La que copiaste de la consola de Firebase)
    // ======================================================
// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyBViFxh-JQio660U2_e_ASjVSHW45oa7oU",
  authDomain: "sorteo-hinojosa.firebaseapp.com",
  databaseURL: "https://sorteo-hinojosa-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "sorteo-hinojosa",
  storageBucket: "sorteo-hinojosa.firebasestorage.app",
  messagingSenderId: "182974610246",
  appId: "1:182974610246:web:e4abcfe4d6791c2f668347",
  measurementId: "G-63YGMJXGG5"
};
    // ======================================================

    // Inicializaci√≥n
    let app, db;
    try {
        app = initializeApp(firebaseConfig);
        db = getDatabase(app);
        console.log("Hinojosa System: Online");
    } catch (e) {
        console.error("Error Firebase", e);
        alert("‚ö†Ô∏è Error: No has pegado la configuraci√≥n de Firebase en el c√≥digo HTML.");
    }

    // --- DATOS DEL EQUIPO (Sin Miguel) ---
    const teamMembers = [
        "Luis Escriv√°", "Nuria Lorenzo", "Ramiro Aguir", "Victor Manuel",
        "Alba Manrique", "Alfredo Garcia", "Andrea S√°nchez", 
        "Carlos Asenjo", "Eduardo Peris", "Francisco Cardona", "Juan Vicente"
    ];
    
    // --- PREMIOS (2 Cavas + Chorras) ---
    const gagPrizes = [
        { title: "Tour Pata Coja", desc: "Vuelta a la oficina a la pata coja.", icon: "ü¶µ" },
        { title: "Error ST22", desc: "Traes caf√©s ma√±ana.", icon: "‚òï" },
        { title: "Licencia SAP", desc: "Un aplauso lento del equipo.", icon: "üëè" },
        { title: "Transporte Fallido", desc: "Cuenta un chiste malo.", icon: "üöõ" },
        { title: "Bucle Infinito", desc: "Repite 'SAP es mi pasi√≥n' 10 veces.", icon: "‚ôæÔ∏è" },
        { title: "Usuario Bloqueado", desc: "Congelado 1 minuto.", icon: "‚ùÑÔ∏è" },
        { title: "Ticket Jira", desc: "Has ganado... nada.", icon: "üé´" },
        { title: "Debug Prod", desc: "Confiesa tu mayor error.", icon: "üêû" },
        { title: "Excel Macros", desc: "Imita teclear enfadado.", icon: "‚å®Ô∏è" },
        { title: "Reinicio", desc: "5 Sentadillas.", icon: "üèãÔ∏è" }
    ];

    // --- L√ìGICA ---
    let currentUser = null;

    async function initGame() {
        if(!db) return;
        const boxesRef = ref(db, 'boxes');
        const usersRef = ref(db, 'users');
        
        // Comprobar si existe partida
        const snapshot = await get(boxesRef);

        if (!snapshot.exists()) {
            console.log("Creando nueva partida...");
            // Configurar 12 cajas (para 11 usuarios + margen)
            const totalBoxes = 12;
            let newBoxes = [];
            let prizesArray = Array(totalBoxes).fill(null);
            
            // Colocar 2 Cavas
            let placed = 0;
            while (placed < 2) {
                let idx = Math.floor(Math.random() * totalBoxes);
                if (prizesArray[idx] === null) {
                    prizesArray[idx] = { type: 'CAVA', title: "¬°GRAN PREMIO!", desc: "Botella de Cava Hinojosa.", icon: "üçæ" };
                    placed++;
                }
            }
            // Rellenar resto
            for(let i=0; i<totalBoxes; i++) {
                if(prizesArray[i] === null) {
                    const gag = gagPrizes[Math.floor(Math.random() * gagPrizes.length)];
                    prizesArray[i] = { type: 'GAG', ...gag };
                }
                newBoxes.push({ id: i, opened: false, openedBy: "", prize: prizesArray[i] });
            }
            
            await set(boxesRef, newBoxes);
            
            // Inicializar usuarios
            let usersObj = {};
            teamMembers.forEach(m => usersObj[btoa(encodeURIComponent(m))] = { name: m, played: false });
            await set(usersRef, usersObj);
        }

        // Listeners en tiempo real
        onValue(boxesRef, (snap) => {
            renderBoxes(snap.val() || []);
            checkBottles(snap.val() || []);
        });

        onValue(usersRef, (snap) => {
            renderUsers(snap.val() || {});
        });
    }

    // Renderizado
    function renderUsers(users) {
        const list = document.getElementById('user-list');
        const select = document.getElementById('who-am-i');
        list.innerHTML = '';
        
        // Rellenar select solo si est√° vac√≠o
        if (select.options.length <= 1) {
             Object.values(users).forEach(u => {
                // Solo a√±adir al select si no ha jugado
                if(!u.played) {
                    const opt = document.createElement('option');
                    opt.value = u.name;
                    opt.innerText = u.name;
                    select.appendChild(opt);
                }
             });
        }

        // Pintar lista lateral
        Object.values(users).forEach(u => {
            const div = document.createElement('div');
            div.className = `p-3 mb-2 rounded border-l-4 flex justify-between items-center text-sm ${u.played ? 'bg-gray-100 border-gray-300 text-gray-400' : 'bg-white border-hinojosa shadow-sm'}`;
            div.innerHTML = `
                <span class="font-semibold">${u.name}</span>
                ${u.played ? '<span class="text-xs">‚úî JUGADO</span>' : '<span class="text-xs text-hinojosa">PENDIENTE</span>'}
            `;
            list.appendChild(div);
        });
    }

    function renderBoxes(boxes) {
        const grid = document.getElementById('grid-container');
        grid.innerHTML = '';
        boxes.forEach((box, idx) => {
            const div = document.createElement('div');
            
            if (box.opened) {
                // CAJA ABIERTA
                const isCava = box.prize.type === 'CAVA';
                div.className = `h-32 rounded shadow-inner border-2 flex flex-col items-center justify-center p-2 text-center transition-all ${isCava ? 'bg-yellow-50 border-yellow-400' : 'bg-gray-200 border-gray-300'}`;
                div.innerHTML = `
                    <div class="text-3xl mb-1">${box.prize.icon}</div>
                    <div class="text-[10px] font-bold text-gray-500 uppercase">Abierto por</div>
                    <div class="text-xs font-bold ${isCava ? 'text-yellow-700' : 'text-gray-600'}">${box.openedBy}</div>
                `;
            } else {
                // CAJA CERRADA (Verde Hinojosa)
                div.className = `h-32 rounded box-closed cursor-pointer relative flex items-center justify-center border-2 border-green-800 text-white`;
                div.onclick = () => handleBoxClick(idx, box);
                div.innerHTML = `
                    <span class="text-4xl font-light opacity-90">${idx + 1}</span>
                    <div class="absolute top-2 right-2 opacity-30 border border-white p-0.5 w-5 h-5 flex items-center justify-center text-[8px] font-bold">H</div>
                `;
            }
            grid.appendChild(div);
        });
    }

    function checkBottles(boxes) {
        const found = boxes.filter(b => b.opened && b.prize.type === 'CAVA').length;
        document.getElementById('bottles-count').innerText = `${2 - found} / 2`;
    }

    // Interacci√≥n
    window.setIdentity = function(name) {
        if(!name) return;
        currentUser = name;
        document.getElementById('status-bar').innerText = `Usuario activo: ${name}`;
        document.getElementById('identity-overlay').classList.add('hidden');
    }

    async function handleBoxClick(idx, box) {
        if (!currentUser) {
            alert("Recarga la p√°gina y selecciona qui√©n eres.");
            return;
        }
        if (box.opened) return;

        if(!confirm(`¬øEst√°s seguro de elegir la Caja ${idx+1}?`)) return;

        // Actualizar DB
        const updates = {};
        updates[`boxes/${idx}/opened`] = true;
        updates[`boxes/${idx}/openedBy`] = currentUser;
        updates[`users/${btoa(encodeURIComponent(currentUser))}/played`] = true;

        await update(ref(db), updates);

        showModal(box.prize);
    }

    function showModal(prize) {
        const modal = document.getElementById('result-modal');
        const icon = document.getElementById('modal-icon');
        const title = document.getElementById('modal-title');
        
        icon.innerText = prize.icon;
        title.innerText = prize.type === 'CAVA' ? "¬°PREMIO HINOJOSA!" : "TRANSACCI√ìN FALLIDA";
        title.className = prize.type === 'CAVA' ? "text-2xl font-bold text-hinojosa mb-2" : "text-2xl font-bold text-gray-600 mb-2";
        
        document.getElementById('modal-msg').innerText = prize.title;
        document.getElementById('modal-desc').innerText = prize.desc;
        
        modal.classList.remove('hidden');
    }

    window.closeModal = function() {
        document.getElementById('result-modal').classList.add('hidden');
        // Forzar recarga para limpiar usuario local y evitar trampas
        location.reload(); 
    }

    // Funci√≥n de reseteo para pruebas (oculta, llamar desde consola o descomentar bot√≥n)
    window.resetSystem = async function() {
        if(confirm("‚ö†Ô∏è ¬øRESET TOTAL? Se borrar√°n todos los datos.")) {
            await remove(ref(db));
            location.reload();
        }
    }

    initGame();
</script>
</head> <body class="flex flex-col h-screen overflow-hidden">

<header class="bg-hinojosa text-white shadow-md z-20 h-16 flex items-center justify-between px-6">
    <div class="flex items-center gap-6">
        <div class="flex items-center gap-2">
            <div class="w-8 h-8 bg-white flex items-center justify-center rounded-sm">
                <span class="text-hinojosa font-bold text-xl">H</span>
            </div>
            <span class="font-bold text-xl tracking-wide hidden md:block">HINOJOSA</span>
        </div>
        
        <div class="h-6 w-px bg-white/30 hidden md:block"></div>
        
        <div class="text-sm font-light tracking-wide uppercase opacity-90 hidden md:block">
            Departamento SAP
        </div>
    </div>

    <div class="flex items-center gap-6">
        <div class="text-right">
            <p class="text-[10px] uppercase opacity-70 tracking-wider">Cavas Disponibles</p>
            <div id="bottles-count" class="text-xl font-bold text-white">2 / 2</div>
        </div>
        <button onclick="resetSystem()" class="text-xs text-white/10 hover:text-red-300 transition" title="Reset DB">‚ö†</button>
    </div>
</header>

<div class="bg-white border-b border-gray-200 py-3 px-6 flex justify-between items-center shadow-sm z-10">
    <div class="flex gap-4 text-xs font-semibold text-gray-500 uppercase tracking-wide">
        <span class="text-hinojosa border-b-2 border-hinojosa pb-3">Sorteo Navidad</span>
        <span class="hover:text-hinojosa cursor-default">Innovaci√≥n</span>
        <span class="hover:text-hinojosa cursor-default">Sostenibilidad</span>
        <span class="hover:text-hinojosa cursor-default">Personas</span>
    </div>
    <div id="status-bar" class="text-xs text-hinojosa font-bold">Esperando identificaci√≥n...</div>
</div>

<div class="flex flex-1 overflow-hidden">
    
    <aside class="w-72 bg-gray-50 border-r border-gray-200 hidden md:flex flex-col">
        <div class="p-4 bg-white border-b border-gray-200">
            <h3 class="text-hinojosa font-bold text-sm uppercase">Participantes</h3>
            <p class="text-xs text-gray-400 mt-1">Hinojosa Packaging X√†tiva</p>
        </div>
        <div id="user-list" class="flex-1 overflow-y-auto p-4">
            <div class="animate-pulse flex space-x-4 mt-4">
                <div class="h-2 bg-gray-200 rounded w-full"></div>
            </div>
        </div>
    </aside>

    <main class="flex-1 relative bg-[#f3f4f6] p-8 flex flex-col items-center justify-start overflow-y-auto">
        
        <div class="w-full max-w-5xl">
            <div class="mb-8 text-center">
                <h1 class="text-3xl font-bold text-hinojosa mb-2">Sorteo Extraordinario</h1>
                <div class="h-1 w-16 bg-hinojosa mx-auto mb-4"></div>
                <p class="text-gray-600 max-w-2xl mx-auto text-sm">
                    Selecciona una "Caja de Empaquetado" para descubrir si contiene un lote premiado o una tarea de mantenimiento SAP.
                </p>
            </div>

            <div id="grid-container" class="grid grid-cols-2 md:grid-cols-4 gap-6">
                </div>
        </div>
        
        <div class="fixed bottom-0 right-0 p-8 opacity-5 pointer-events-none">
            <svg width="200" height="200" viewBox="0 0 100 100" fill="#005836">
                <path d="M10 10 H90 V90 H10 Z M20 20 V80 H80 V20 Z" />
            </svg>
        </div>
    </main>
</div>

<div id="identity-overlay" class="fixed inset-0 bg-hinojosa/95 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded shadow-2xl max-w-md w-full p-8 text-center">
        <div class="w-12 h-12 bg-hinojosa text-white font-bold text-2xl flex items-center justify-center mx-auto mb-4 rounded">H</div>
        <h3 class="text-xl font-bold text-gray-800 mb-2">Bienvenido al Portal</h3>
        <p class="mb-6 text-gray-500 text-sm">Por favor, identif√≠cate para registrar tu participaci√≥n en el sistema.</p>
        
        <select id="who-am-i" class="w-full p-3 border border-gray-300 rounded mb-6 text-gray-700 bg-gray-50 focus:outline-none focus:border-hinojosa transition">
            <option value="" disabled selected>-- Seleccionar Usuario SAP --</option>
        </select>
        
        <button onclick="setIdentity(document.getElementById('who-am-i').value)" class="w-full bg-hinojosa text-white font-bold py-3 px-6 rounded hover:bg-[#004d2e] transition shadow-lg uppercase tracking-wide text-sm">
            Acceder
        </button>
    </div>
</div>

<div id="result-modal" class="fixed inset-0 bg-black/60 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
    <div class="bg-white rounded-lg shadow-2xl max-w-lg w-full overflow-hidden transform transition-all">
        <div class="h-2 bg-hinojosa w-full"></div>
        <div class="p-8 text-center">
            <div id="modal-icon" class="text-6xl mb-6 animate-bounce">üéÅ</div>
            <h2 id="modal-title" class="text-2xl font-bold text-gray-800">Resultado</h2>
            
            <div class="bg-gray-50 border border-gray-200 p-4 rounded-lg my-4">
                <p id="modal-msg" class="text-lg font-bold text-hinojosa mb-1">...</p>
                <p id="modal-desc" class="text-sm text-gray-500 italic">...</p>
            </div>
            
            <button onclick="closeModal()" class="mt-4 bg-gray-800 text-white px-8 py-2 rounded hover:bg-black transition text-sm font-bold uppercase">
                Cerrar
            </button>
        </div>
    </div>
</div>
</body> </html>