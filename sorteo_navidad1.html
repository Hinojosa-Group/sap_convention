<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hinojosa | Sorteo Comida Navidad</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { 
            font-family: 'Montserrat', sans-serif; 
            background-color: #f9fafb;
        }
        /* Verde Corporativo Hinojosa */
        .bg-hinojosa { background-color: #005836; }
        .text-hinojosa { color: #005836; }
        .border-hinojosa { border-color: #005836; }
        .bg-wine { background-color: #722F37; } /* Color Vino */
        .text-wine { color: #722F37; }
        
        .box-closed {
            background: linear-gradient(135deg, #005836 0%, #004d2e 100%);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .box-closed:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgba(0, 88, 54, 0.3);
        }

        @keyframes pulse-wine {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        .animate-wine {
            animation: pulse-wine 1s infinite;
        }
    </style>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, get, onValue, update, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // ======================================================
        // CONFIGURACI√ìN DE FIREBASE
        // ======================================================
        const firebaseConfig = {
            apiKey: "AIzaSyBViFxh-JQio660U2_e_ASjVSHW45oa7oU",
            authDomain: "sorteo-hinojosa.firebaseapp.com",
            databaseURL: "https://sorteo-hinojosa-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "sorteo-hinojosa",
            storageBucket: "sorteo-hinojosa.firebasestorage.app",
            messagingSenderId: "182974610246",
            appId: "1:182974610246:web:e4abcfe4d6791c2f668347",
            measurementId: "G-63YGMJXGG5"
        };
        // ======================================================

        let app, db;
        try {
            app = initializeApp(firebaseConfig);
            db = getDatabase(app);
            console.log("Hinojosa System: Online");
        } catch (e) {
            console.error("Error Firebase", e);
            alert("‚ö†Ô∏è Error conectando con Firebase. Revisa la consola.");
        }

        // --- EQUIPO ACTUALIZADO (Con Juanvi) ---
        const teamMembers = [
            "Luis", "Miguel", "Charly", "Victor", 
            "Alfredo", "Joan", "Miguel (Jr)", "Jose", "Juanvi"
        ];
        
        // --- PREMIOS (VINO) Y CASTIGOS (OFICINA) ---
        const gagPrizes = [
            { title: "Escalera al Cielo", desc: "Sube un tramo de escaleras (o da una vuelta a la sala) a la pata coja.", icon: "ü¶µ" },
            { title: "El Discurso del Rey", desc: "Te toca hacer el primer brindis en la comida de hoy.", icon: "ü•Ç" },
            { title: "Operaci√≥n Triunfo", desc: "Canta el estribillo de un villancico a pleno pulm√≥n ahora mismo.", icon: "üé§" },
            { title: "El Becario", desc: "Tienes que servir agua/vino a tus compa√±eros de mesa hoy.", icon: "üç∑" },
            { title: "Influencer Hinojosa", desc: "Hazte un selfie con el jefe poniendo 'morritos'.", icon: "üì∏" },
            { title: "Confesi√≥n SAP", desc: "Confiesa delante de todos tu mayor 'cagada' en el sistema este a√±o.", icon: "üí©" },
            { title: "Sentadillas Pre-Comida", desc: "Haz 10 sentadillas para hacer hueco al men√∫.", icon: "üèãÔ∏è" },
            { title: "Imitaci√≥n", desc: "Imita c√≥mo teclea o habla uno de los presentes (que adivinen qui√©n).", icon: "üé≠" },
            { title: "Chiste Malo", desc: "Cuenta el peor chiste que sepas. Si nadie se r√≠e, repites.", icon: "ü§°" },
            { title: "Bailando con Lobos", desc: "Haz un paso de baile (tipo Fortnite o Macarena) en el centro.", icon: "üíÉ" }
        ];

        let currentUser = null;

        async function initGame() {
            if(!db) return;
            const boxesRef = ref(db, 'boxes');
            const usersRef = ref(db, 'users');
            
            const snapshot = await get(boxesRef);

            // Si no hay datos (o se ha reseteado), creamos la partida nueva
            if (!snapshot.exists()) {
                console.log("Creando sorteo de vinos...");
                // Usamos 12 cajas para 9 usuarios (sobran 3 cajas vac√≠as/extra)
                const totalBoxes = 12; 
                let newBoxes = [];
                let prizesArray = Array(totalBoxes).fill(null);
                
                // 1. Colocar 2 Botellas de Vino
                let placed = 0;
                while (placed < 2) {
                    let idx = Math.floor(Math.random() * totalBoxes);
                    if (prizesArray[idx] === null) {
                        prizesArray[idx] = { type: 'VINO', title: "¬°BOTELLA DE VINO!", desc: "Te llevas un vinito rico para casa. ¬°Salud!", icon: "üç∑" };
                        placed++;
                    }
                }
                // 2. Rellenar el resto con pruebas graciosas
                for(let i=0; i<totalBoxes; i++) {
                    if(prizesArray[i] === null) {
                        const gag = gagPrizes[Math.floor(Math.random() * gagPrizes.length)];
                        prizesArray[i] = { type: 'GAG', ...gag };
                    }
                    newBoxes.push({ id: i, opened: false, openedBy: "", prize: prizesArray[i] });
                }
                
                await set(boxesRef, newBoxes);
                
                // 3. Inicializar usuarios
                let usersObj = {};
                teamMembers.forEach(m => usersObj[btoa(encodeURIComponent(m))] = { name: m, played: false });
                await set(usersRef, usersObj);
            }

            // Listeners
            onValue(boxesRef, (snap) => {
                const data = snap.val();
                if (data) {
                    renderBoxes(data);
                    checkBottles(data);
                }
            });

            onValue(usersRef, (snap) => {
                const data = snap.val();
                if (data) renderUsers(data);
            });
        }

        function renderUsers(users) {
            const list = document.getElementById('user-list');
            const select = document.getElementById('who-am-i');
            
            list.innerHTML = '';
            const usersArray = Object.values(users);

            // Rellenar select solo si hace falta
            if (select.options.length <= 1) {
                 usersArray.forEach(u => {
                    if(!u.played) {
                        const opt = document.createElement('option');
                        opt.value = u.name;
                        opt.innerText = u.name;
                        select.appendChild(opt);
                    }
                 });
            }

            usersArray.forEach(u => {
                const div = document.createElement('div');
                div.className = `p-3 mb-2 rounded border-l-4 flex justify-between items-center text-sm ${u.played ? 'bg-gray-100 border-gray-300 text-gray-400' : 'bg-white border-hinojosa shadow-sm'}`;
                div.innerHTML = `
                    <span class="font-semibold">${u.name}</span>
                    ${u.played ? '<span class="text-xs">‚úî LISTO</span>' : '<span class="text-xs text-hinojosa">ESPERANDO</span>'}
                `;
                list.appendChild(div);
            });
        }

        function renderBoxes(boxes) {
            const grid = document.getElementById('grid-container');
            grid.innerHTML = '';
            boxes.forEach((box, idx) => {
                const div = document.createElement('div');
                
                if (box.opened) {
                    const isWine = box.prize.type === 'VINO';
                    div.className = `h-32 rounded shadow-inner border-2 flex flex-col items-center justify-center p-2 text-center transition-all ${isWine ? 'bg-red-50 border-red-800' : 'bg-gray-200 border-gray-300'}`;
                    div.innerHTML = `
                        <div class="text-4xl mb-1">${box.prize.icon}</div>
                        <div class="text-[10px] font-bold text-gray-500 uppercase">Abierto por</div>
                        <div class="text-xs font-bold ${isWine ? 'text-wine' : 'text-gray-600'}">${box.openedBy}</div>
                    `;
                } else {
                    div.className = `h-32 rounded box-closed cursor-pointer relative flex items-center justify-center border-2 border-green-800 text-white`;
                    div.onclick = () => handleBoxClick(idx, box);
                    div.innerHTML = `
                        <span class="text-4xl font-light opacity-90">${idx + 1}</span>
                        <div class="absolute top-2 right-2 opacity-30 border border-white p-0.5 w-5 h-5 flex items-center justify-center text-[8px] font-bold">H</div>
                    `;
                }
                grid.appendChild(div);
            });
        }

        function checkBottles(boxes) {
            const found = boxes.filter(b => b.opened && b.prize.type === 'VINO').length;
            document.getElementById('bottles-count').innerText = `${2 - found} / 2`;
        }

        window.setIdentity = function(name) {
            if(!name) return;
            currentUser = name;
            document.getElementById('status-bar').innerText = `Jugador: ${name}`;
            document.getElementById('identity-overlay').classList.add('hidden');
        }

        async function handleBoxClick(idx, box) {
            if (!currentUser) {
                alert("Identif√≠cate primero.");
                return;
            }
            if (box.opened) return;

            if(!confirm(`¬øSeguro que abres la caja ${idx+1}?`)) return;

            const updates = {};
            updates[`boxes/${idx}/opened`] = true;
            updates[`boxes/${idx}/openedBy`] = currentUser;
            updates[`users/${btoa(encodeURIComponent(currentUser))}/played`] = true;

            await update(ref(db), updates);
            showModal(box.prize);
        }

        function showModal(prize) {
            const modal = document.getElementById('result-modal');
            const icon = document.getElementById('modal-icon');
            const title = document.getElementById('modal-title');
            
            icon.innerText = prize.icon;
            
            if (prize.type === 'VINO') {
                title.innerText = "¬°PREMIO GORDO!";
                title.className = "text-3xl font-bold text-wine mb-2 animate-wine";
                icon.className = "text-6xl mb-6 animate-bounce";
            } else {
                title.innerText = "¬°CASTIGO!";
                title.className = "text-2xl font-bold text-gray-600 mb-2";
                icon.className = "text-6xl mb-6";
            }
            
            document.getElementById('modal-msg').innerText = prize.title;
            document.getElementById('modal-desc').innerText = prize.desc;
            
            modal.classList.remove('hidden');
        }

        window.closeModal = function() {
            document.getElementById('result-modal').classList.add('hidden');
            location.reload(); 
        }

        window.resetSystem = async function() {
            if(confirm("‚ö†Ô∏è ¬øRESET TOTAL? Se borrar√°n todos los datos para empezar el sorteo nuevo.")) {
                await remove(ref(db));
                location.reload();
            }
        }

        initGame();
    </script>
</head>
<body class="flex flex-col h-screen overflow-hidden">

    <header class="bg-hinojosa text-white shadow-md z-20 h-16 flex items-center justify-between px-6">
        <div class="flex items-center gap-6">
            <div class="flex items-center gap-2">
                <div class="w-8 h-8 bg-white flex items-center justify-center rounded-sm">
                    <span class="text-hinojosa font-bold text-xl">H</span>
                </div>
                <span class="font-bold text-xl tracking-wide hidden md:block">HINOJOSA</span>
            </div>
            <div class="h-6 w-px bg-white/30 hidden md:block"></div>
            <div class="text-sm font-light tracking-wide uppercase opacity-90 hidden md:block">
                Especial Navidad
            </div>
        </div>

        <div class="flex items-center gap-6">
            <div class="text-right">
                <p class="text-[10px] uppercase opacity-70 tracking-wider">Vinos Restantes</p>
                <div id="bottles-count" class="text-xl font-bold text-white">2 / 2</div>
            </div>
            <button onclick="resetSystem()" class="text-lg text-white/50 hover:text-red-400 transition" title="Resetear Sorteo">‚ö†</button>
        </div>
    </header>

    <div class="bg-white border-b border-gray-200 py-3 px-6 flex justify-between items-center shadow-sm z-10">
        <div class="flex gap-4 text-xs font-semibold text-gray-500 uppercase tracking-wide">
            <span class="text-hinojosa border-b-2 border-hinojosa pb-3">Comida de Empresa</span>
            <span class="hover:text-hinojosa cursor-default">Vino</span>
            <span class="hover:text-hinojosa cursor-default">Risas</span>
            <span class="hover:text-hinojosa cursor-default">Equipo</span>
        </div>
        <div id="status-bar" class="text-xs text-hinojosa font-bold">Calentando motores...</div>
    </div>

    <div class="flex flex-1 overflow-hidden">
        
        <aside class="w-72 bg-gray-50 border-r border-gray-200 hidden md:flex flex-col">
            <div class="p-4 bg-white border-b border-gray-200">
                <h3 class="text-hinojosa font-bold text-sm uppercase">Participantes</h3>
                <p class="text-xs text-gray-400 mt-1">Dpto. SAP</p>
            </div>
            <div id="user-list" class="flex-1 overflow-y-auto p-4">
                <div class="animate-pulse flex space-x-4 mt-4">
                    <div class="h-2 bg-gray-200 rounded w-full"></div>
                </div>
            </div>
        </aside>

        <main class="flex-1 relative bg-[#f3f4f6] p-8 flex flex-col items-center justify-start overflow-y-auto">
            
            <div class="w-full max-w-5xl">
                <div class="mb-8 text-center">
                    <h1 class="text-3xl font-bold text-hinojosa mb-2">Sorteo Pre-Comida</h1>
                    <div class="h-1 w-16 bg-hinojosa mx-auto mb-4"></div>
                    <p class="text-gray-600 max-w-2xl mx-auto text-sm">
                        Elige tu caja. O te llevas el vino para la comida, o te toca hacer el rid√≠culo antes de irnos. ¬°Suerte!
                    </p>
                </div>

                <div id="grid-container" class="grid grid-cols-2 md:grid-cols-4 gap-6">
                    </div>
            </div>
            
            <div class="fixed bottom-0 right-0 p-8 opacity-5 pointer-events-none">
                <svg width="200" height="200" viewBox="0 0 100 100" fill="#005836">
                    <path d="M10 10 H90 V90 H10 Z M20 20 V80 H80 V20 Z" />
                </svg>
            </div>
        </main>
    </div>

    <div id="identity-overlay" class="fixed inset-0 bg-hinojosa/95 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded shadow-2xl max-w-md w-full p-8 text-center">
            <div class="w-12 h-12 bg-hinojosa text-white font-bold text-2xl flex items-center justify-center mx-auto mb-4 rounded">H</div>
            <h3 class="text-xl font-bold text-gray-800 mb-2">¬øQui√©n eres?</h3>
            <p class="mb-6 text-gray-500 text-sm">Selecciona tu nombre para jugar.</p>
            
            <select id="who-am-i" class="w-full p-3 border border-gray-300 rounded mb-6 text-gray-700 bg-gray-50 focus:outline-none focus:border-hinojosa transition">
                <option value="" disabled selected>-- Seleccionar Nombre --</option>
            </select>
            
            <button onclick="setIdentity(document.getElementById('who-am-i').value)" class="w-full bg-hinojosa text-white font-bold py-3 px-6 rounded hover:bg-[#004d2e] transition shadow-lg uppercase tracking-wide text-sm">
                Entrar al Sorteo
            </button>
        </div>
    </div>

    <div id="result-modal" class="fixed inset-0 bg-black/60 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-lg shadow-2xl max-w-lg w-full overflow-hidden transform transition-all">
            <div class="h-2 bg-hinojosa w-full"></div>
            <div class="p-8 text-center">
                <div id="modal-icon" class="text-6xl mb-6">üéÅ</div>
                <h2 id="modal-title" class="text-2xl font-bold text-gray-800">Resultado</h2>
                
                <div class="bg-gray-50 border border-gray-200 p-4 rounded-lg my-4">
                    <p id="modal-msg" class="text-lg font-bold text-hinojosa mb-1">...</p>
                    <p id="modal-desc" class="text-sm text-gray-500 italic">...</p>
                </div>
                
                <button onclick="closeModal()" class="mt-4 bg-gray-800 text-white px-8 py-2 rounded hover:bg-black transition text-sm font-bold uppercase">
                    Continuar
                </button>
            </div>
        </div>
    </div>
</body>
</html>
